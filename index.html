<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Postulaciones - Cristopher Belardy</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out { animation: fade-in-out 3s ease-in-out forwards; }
    </style>
</head>
<body class="bg-slate-900 bg-gradient-to-br from-slate-900 to-purple-900/50 text-gray-300 min-h-screen">

    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASO CLAVE: Pega tu objeto de configuración de Firebase aquí ---
        // Este es un placeholder. Debes reemplazarlo con tu configuración real.
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        
        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // Make Firebase services globally available for the React script
            window.db = db;
            window.auth = auth;
            window.firebase = {
                collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, 
                signInAnonymously, onAuthStateChanged, signInWithCustomToken, query, writeBatch
            };
            // Notify React that Firebase is ready
            window.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (error) {
            console.error("Error initializing Firebase. Please check your firebaseConfig.", error);
            // You could display an error message to the user here
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- SVG Icons ---
        const PlusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>);
        const TrashIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>);
        const LinkIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>);
        const ExternalLinkIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="ml-2 opacity-70 group-hover:opacity-100"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>);
        const ExportIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>);
        const ImportIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>);

        function App() {
            const [applications, setApplications] = useState([]);
            const [newApplication, setNewApplication] = useState({ company: '', title: '', url: '' });
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [notification, setNotification] = useState('');
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);

            // Effect to handle Firebase initialization and authentication
            useEffect(() => {
                const onFirebaseReady = () => {
                    const { onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebase;
                    const auth = window.auth;

                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            setUser(user);
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                setError("Error de autenticación. No se pueden guardar datos.");
                            }
                        }
                    });
                    setFirebaseReady(true);
                    return () => unsubscribe();
                };
                
                window.addEventListener('firebase-ready', onFirebaseReady);
                
                if(window.firebase) {
                    onFirebaseReady();
                }

                return () => window.removeEventListener('firebase-ready', onFirebaseReady);
            }, []);

            // Effect to fetch and listen to data from Firestore
            useEffect(() => {
                if (!user) return;

                setIsLoading(true);
                const { collection, query, onSnapshot } = window.firebase;
                const db = window.db;

                const collRef = collection(db, "users", user.uid, "applications");
                const q = query(collRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let apps = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        createdAt: doc.data().createdAt?.toDate().toISOString()
                    }));
                    apps.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    setApplications(apps);
                    setIsLoading(false);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    setError("No se pudieron cargar los datos. Revisa la consola.");
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const showNotification = (message) => {
                setNotification(message);
                setTimeout(() => setNotification(''), 3000);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setNewApplication(prev => ({ ...prev, [name]: value }));
            };

            const addApplication = async (e) => {
                e.preventDefault();
                if (!user) {
                    setError("Debes estar autenticado para añadir postulaciones.");
                    return;
                }
                if (!newApplication.url.trim() || !newApplication.company.trim() || !newApplication.title.trim()) {
                    setError("Por favor, completa todos los campos.");
                    return;
                }
                
                const { collection, addDoc, serverTimestamp } = window.firebase;
                const db = window.db;
                const collRef = collection(db, "users", user.uid, "applications");

                try {
                    await addDoc(collRef, {
                        ...newApplication,
                        status: 'Aplicado',
                        createdAt: serverTimestamp()
                    });
                    setNewApplication({ company: '', title: '', url: '' });
                    setError('');
                    showNotification("¡Postulación añadida!");
                } catch (err) {
                    console.error("Error adding document: ", err);
                    setError("No se pudo guardar la postulación.");
                }
            };
            
            const updateStatus = async (id, status) => {
                const { doc, updateDoc } = window.firebase;
                const db = window.db;
                const docRef = doc(db, "users", user.uid, "applications", id);
                try {
                    await updateDoc(docRef, { status });
                } catch (err) {
                    console.error("Error updating status: ", err);
                    setError("No se pudo actualizar el estado.");
                }
            };

            const deleteApplication = async (id) => {
               if (window.confirm("¿Estás seguro de que quieres eliminar esta postulación?")) {
                    const { doc, deleteDoc } = window.firebase;
                    const db = window.db;
                    const docRef = doc(db, "users", user.uid, "applications", id);
                    try {
                        await deleteDoc(docRef);
                        showNotification("Postulación eliminada.");
                    } catch (err) {
                        console.error("Error deleting document: ", err);
                        setError("No se pudo eliminar la postulación.");
                    }
                }
            };

            const exportToJson = () => {
                if(applications.length === 0) {
                    showNotification("No hay postulaciones para exportar.");
                    return;
                }
                const dataStr = JSON.stringify(applications, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const now = new Date();
                const exportFileDefaultName = `mis_postulaciones_${now.toISOString().slice(0,10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                showNotification("¡Datos exportados exitosamente!");
            };

            const importFromJson = (event) => {
                const fileReader = new FileReader();
                const file = event.target.files[0];
                if (!file || !user) return;

                fileReader.readAsText(file, "UTF-8");
                fileReader.onload = async e => {
                    try {
                        const parsedApps = JSON.parse(e.target.result);
                        if (!Array.isArray(parsedApps)) throw new Error("Formato inválido.");

                        const { writeBatch, doc, collection } = window.firebase;
                        const db = window.db;
                        const batch = writeBatch(db);
                        const collRef = collection(db, "users", user.uid, "applications");

                        parsedApps.forEach(app => {
                            const docRef = doc(collRef, app.id || undefined);
                            batch.set(docRef, {
                                ...app,
                                createdAt: new Date(app.createdAt)
                            });
                        });

                        await batch.commit();
                        showNotification("¡Postulaciones importadas exitosamente a la nube!");
                    } catch (err) {
                        setError("El archivo está corrupto o no tiene el formato correcto.");
                        console.error(err);
                    }
                };
                event.target.value = '';
            };

            const statusOptions = ["Aplicado", "En revisión", "Entrevista", "Prueba técnica", "Rechazado", "Oferta"];
            const getStatusColor = (status) => {
                switch (status) {
                    case "Aplicado": return "bg-blue-500/20 text-blue-300 border-blue-500/30";
                    case "En revisión": return "bg-yellow-500/20 text-yellow-300 border-yellow-500/30";
                    case "Entrevista": return "bg-green-500/20 text-green-300 border-green-500/30";
                    case "Prueba técnica": return "bg-purple-500/20 text-purple-300 border-purple-500/30";
                    case "Oferta": return "bg-emerald-500/20 text-emerald-300 border-emerald-500/30";
                    case "Rechazado": return "bg-red-500/20 text-red-300 border-red-500/30";
                    default: return "bg-gray-500/20 text-gray-300 border-gray-500/30";
                }
            };
            
            if (!firebaseReady) {
                 return <div className="flex items-center justify-center h-screen"><p className="text-center text-gray-500 text-xl">Cargando servicios de Firebase...</p></div>
            }

            return (
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    {notification && (<div className="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg animate-fade-in-out">{notification}</div>)}
                    <header className="mb-8">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-4xl sm:text-5xl font-black text-white tracking-tight">Gestor de Postulaciones</h1>
                                <p className="text-gray-400 mt-2">Hola Cristopher, bienvenido a tu centro de mando laboral.</p>
                            </div>
                            <div className="flex space-x-2 mt-2">
                                <label htmlFor="import-button" className="cursor-pointer border border-purple-500/50 text-purple-400 font-bold py-2 px-4 rounded-md hover:bg-purple-500/10 hover:border-purple-500 transition-all duration-200 flex items-center">
                                    <ImportIcon />
                                    <span className="ml-2 hidden sm:inline">Importar</span>
                                </label>
                                <input type="file" id="import-button" className="hidden" accept=".json" onChange={importFromJson} />
                                <button onClick={exportToJson} className="cursor-pointer border border-purple-500/50 text-purple-400 font-bold py-2 px-4 rounded-md hover:bg-purple-500/10 hover:border-purple-500 transition-all duration-200 flex items-center">
                                    <ExportIcon />
                                    <span className="ml-2 hidden sm:inline">Exportar</span>
                                </button>
                            </div>
                        </div>
                    </header>
                    <div className="bg-slate-800/80 backdrop-blur-sm p-6 rounded-xl shadow-2xl shadow-purple-900/10 mb-8 border border-slate-700">
                        <form onSubmit={addApplication} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div className="col-span-1 md:col-span-4">
                                <h2 className="text-xl font-semibold text-white mb-4">Añadir nueva postulación</h2>
                            </div>
                            <div>
                                <label htmlFor="company" className="block text-sm font-medium text-gray-400 mb-1">Empresa</label>
                                <input id="company" name="company" type="text" value={newApplication.company} onChange={handleInputChange} placeholder="Ej: SpaceX" className="w-full bg-slate-900 text-white px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 transition"/>
                            </div>
                            <div>
                                <label htmlFor="title" className="block text-sm font-medium text-gray-400 mb-1">Cargo</label>
                                <input id="title" name="title" type="text" value={newApplication.title} onChange={handleInputChange} placeholder="Ej: Ingeniero de Cohetes" className="w-full bg-slate-900 text-white px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 transition"/>
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="url" className="block text-sm font-medium text-gray-400 mb-1">URL de la Oferta</label>
                                <input id="url" name="url" type="url" value={newApplication.url} onChange={handleInputChange} placeholder="https://www.getonbrd.com/..." className="w-full bg-slate-900 text-white px-3 py-2 border border-slate-600 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 transition"/>
                            </div>
                            <div className="md:col-span-4">
                                <button type="submit" className="w-full md:w-auto flex items-center justify-center bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-500 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-purple-500/50 transition-all duration-200">
                                    <PlusIcon />
                                    <span className="ml-2">Guardar Postulación</span>
                                </button>
                            </div>
                        </form>
                        {error && <p className="text-red-400 text-sm mt-4">{error}</p>}
                    </div>
                    <div className="space-y-4">
                        {isLoading ? (
                            <div className="flex items-center justify-center h-48"><p className="text-center text-gray-500 text-xl">Conectando a la base de datos...</p></div>
                        ) : applications.length === 0 ? (
                            <div className="text-center py-16 bg-slate-800/50 rounded-lg shadow-inner border border-slate-700/50">
                                <h3 className="text-xl font-semibold text-white">Aún no hay misiones</h3>
                                <p className="text-gray-400 mt-2">Usa el formulario para empezar a registrar tus postulaciones.</p>
                            </div>
                        ) : (
                            applications.map(app => (
                                <div key={app.id} className="bg-slate-800/80 backdrop-blur-sm p-5 rounded-lg shadow-lg shadow-purple-900/10 border border-slate-700 hover:border-purple-500/50 transition-all duration-300">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                        <div className="flex-1 mb-4 sm:mb-0 mr-4">
                                            <h3 className="text-lg font-bold text-white">{app.title}</h3>
                                            <p className="text-gray-400">{app.company}</p>
                                            <p className="text-sm text-gray-500 mt-1">
                                                Aplicado el: {app.createdAt ? new Date(app.createdAt).toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Fecha no disponible'}
                                            </p>
                                            <a href={app.url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center text-purple-400 hover:text-purple-300 text-sm mt-2 group transition">
                                                <LinkIcon /> <span className="ml-2">Ver oferta original</span> <ExternalLinkIcon />
                                            </a>
                                        </div>
                                        <div className="flex items-center space-x-3 w-full sm:w-auto">
                                            <select
                                                value={app.status}
                                                onChange={(e) => updateStatus(app.id, e.target.value)}
                                                className={`text-sm font-medium py-1 px-3 rounded-full border-2 appearance-none focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-purple-400 transition ${getStatusColor(app.status)}`}
                                            >
                                                {statusOptions.map(option => <option key={option} value={option}>{option}</option>)}
                                            </select>
                                            <button onClick={() => deleteApplication(app.id)} className="text-gray-500 hover:text-red-400 p-2 rounded-full hover:bg-red-500/10 transition-colors">
                                                <TrashIcon />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
